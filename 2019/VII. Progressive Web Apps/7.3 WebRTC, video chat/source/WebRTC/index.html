<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <style type="text/css">
        html {
            height: 100%;
        }

        body {
            height: 100%;
            margin: 0;
            background: #111;
            text-align: center;
        }

        #remoteVideo {
            height: 70%;
            margin-top: 5%;
            background: #000;
        }

        #localVideo {
            width: 20%;
            position: absolute;
            right: 1.1em;
            bottom: 1em;`
            border: 1px solid #333;
            background: #000;
        }

        #callButton {
            position: absolute;
            display: none;
            left: 50%;
            font-size: 2em;
            bottom: 5%;
            border-radius: 1em;
        }
    </style>
</head>
<script src="/socket.io/socket.io.js"></script>

<video id="localVideo" autoplay muted></video>
<div id="videos">

</div>
<button id="callButton" onclick="createOffer()">âœ†</button>

<script>
    var PeerConnection = window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
    var IceCandidate = window.mozRTCIceCandidate || window.RTCIceCandidate;
    var SessionDescription = window.mozRTCSessionDescription || window.RTCSessionDescription;
    navigator.getUserMedia = navigator.getUserMedia || navigator.mozGetUserMedia || navigator.webkitGetUserMedia;

    var pc; // PeerConnection
    var pc1; // PeerConnection
    var pc2; // PeerConnection
    var pc3; // PeerConnection


    // Step 1. getUserMedia
    navigator.getUserMedia(
        { audio: true, video: true },
        gotStream,
        function (error) { console.log(error) }
    );

    function gotStream(stream) {
        document.getElementById("callButton").style.display = 'inline-block';
        const localVideo = document.getElementById("localVideo");
        try {
            localVideo.srcObject = stream;
        } catch (error) {
            localVideo.src = window.URL.createObjectURL(stream);
        }
      //  document.getElementById("localVideo").src = URL.createObjectURL(stream);

        pc = new PeerConnection(null);
        pc.addStream(stream);
        pc.onicecandidate = gotIceCandidate;
        pc.onaddstream = gotRemoteStream;
    }


    // Step 2. createOffer
    function createOffer() {
        pc.createOffer(
            gotLocalDescription,
            function (error) { console.log(error) },
            { 'mandatory': { 'OfferToReceiveAudio': true, 'OfferToReceiveVideo': true } }
        );
    }


    // Step 3. createAnswer
    function createAnswer() {
        pc.createAnswer(
            gotLocalDescription,
            function (error) { console.log(error) },
            { 'mandatory': { 'OfferToReceiveAudio': true, 'OfferToReceiveVideo': true } }
        );
    }


    function gotLocalDescription(description) {
        pc.setLocalDescription(description);
        console.log('description', description);
        sendMessage(description);
    }

    function gotIceCandidate(event) {
        if (event.candidate) {
            sendMessage({
                type: 'candidate',
                label: event.candidate.sdpMLineIndex,
                id: event.candidate.sdpMid,
                candidate: event.candidate.candidate
            });
        }
    }

    function gotRemoteStream(event) {
        console.log(event);


        if (!document.getElementById(`remoteVideo${event.stream.id}`)) {
            var video = document.createElement('video');
            try {
                video.srcObject = event.stream;
            } catch (error) {
                video.src = window.URL.createObjectURL(event.stream);
            }

            video.autoplay = true;
            video.id = event.stream.id;
            document.getElementById("videos").appendChild(video);
        }
        else {
            let videos = document.getElementById(`remoteVideo${event.stream.id}`);
            try {
                videos.srcObject = event.stream;
            } catch (error) {
                vidvideoseo.src = window.URL.createObjectURL(event.stream);
            }
           // document.getElementById(`remoteVideo${event.stream.id}`).src = URL.createObjectURL(event.stream);
        }

    }


    ////////////////////////////////////////////////
    // Socket.io

    var socket = io.connect('', { port: 5000 });

    function sendMessage(message) {
        socket.emit('message', message);
    }

    socket.on('message', function (message) {
        if (message.type === 'offer') {
            pc.setRemoteDescription(new SessionDescription(message));
            createAnswer();
        }
        else if (message.type === 'answer') {
            pc.setRemoteDescription(new SessionDescription(message));
        }
        else if (message.type === 'candidate') {
            var candidate = new IceCandidate({ sdpMLineIndex: message.label, candidate: message.candidate });
            pc.addIceCandidate(candidate);
        }
    });

</script>

</html>